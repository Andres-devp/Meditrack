<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Medicamentos - MediTrack</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="images/app-icon.png" type="image/png">
</head>
<body>
    <div class="app-container">
        <!-- Barra lateral -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="images/app-icon.png" alt="MediTrack" width="30" height="30">
                    MediTrack
                </div>
            </div>
            <nav class="sidebar-nav">
                <a href="patient_dashboard.html" class="sidebar-nav-item">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="medications.html" class="sidebar-nav-item active">
                    <i class="fas fa-pills"></i> Medicamentos
                </a>
                <a href="appointments.html" class="sidebar-nav-item">
                    <i class="fas fa-calendar-check"></i> Citas
                </a>
                <a href="symptom_history.html" class="sidebar-nav-item">
                    <i class="fas fa-heart-pulse"></i> Síntomas
                </a>
                <a href="rewards.html" class="sidebar-nav-item">
                    <i class="fas fa-trophy"></i> Recompensas
                </a>
                <a href="patient_profile.html" class="sidebar-nav-item">
                    <i class="fas fa-user"></i> Perfil
                </a>
                <a href="#" id="logoutBtn" class="sidebar-nav-item">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </a>
            </nav>
        </aside>

        <!-- Contenido principal -->
        <main class="main-content">
            <!-- Encabezado -->
            <header class="header">
                <div class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </div>
                <div class="header-title">Mis Medicamentos</div>
                <div class="header-actions">
                    <a href="add_medication.html" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Añadir
                    </a>
                </div>
            </header>

            <!-- Área de contenido -->
            <div class="content-area">
                <div class="page-header">
                    <p>Gestiona y realiza un seguimiento de tus medicamentos actuales.</p>
                    
                    <!-- Filtros -->
                    <div class="filters">
                        <div class="filter-group">
                            <label for="statusFilter">Estado</label>
                            <select id="statusFilter">
                                <option value="all">Todos</option>
                                <option value="active">Activos</option>
                                <option value="completed">Completados</option>
                            </select>
                        </div>
                        
                        <div class="search-box">
                            <input type="text" id="medicationSearch" placeholder="Buscar medicamento...">
                            <button type="button" id="searchBtn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Mensajes de alerta -->
                <div id="alertMessage" class="alert" style="display: none;"></div>
                
                <!-- Lista de medicamentos -->
                <div id="medicationsList" class="medications-list">
                    <!-- Ejemplo de tarjeta de medicamento (se cargará dinámicamente) -->
                    <div class="medication-card">
                        <div class="medication-card-header">
                            <h3>Ibuprofeno</h3>
                            <span class="medication-status status-active">Activo</span>
                        </div>
                        <div class="medication-card-body">
                            <div class="med-info-row">
                                <div class="med-time-row">
                                    <div class="med-time-indicator med-time-morning">M</div>
                                    <span>8:00 AM</span>
                                </div>
                                <div class="med-time-row">
                                    <div class="med-time-indicator med-time-evening">T</div>
                                    <span>8:00 PM</span>
                                </div>
                            </div>
                            <p><strong>Dosis:</strong> 400mg</p>
                            <p><strong>Próxima toma:</strong> <span class="highlight-text">Hoy, 8:00 PM</span></p>
                        </div>
                        <div class="medication-card-footer">
                            <button class="btn btn-sm btn-primary take-dose-btn">Tomar dosis</button>
                            <button class="btn btn-sm btn-outline view-details-btn">Ver detalles</button>
                        </div>
                    </div>
                    
                    <div class="empty-state" style="display: none;">
                        <div class="feature-icon-container feature-icon-med">
                            <i class="fas fa-prescription-bottle-medical"></i>
                        </div>
                        <p>No se encontraron medicamentos.</p>
                        <a href="add_medication.html" class="btn btn-primary mt-2">Añadir Medicamento</a>
                    </div>
                </div>
            </div>
        </main>

        <!-- Barra de navegación inferior para móviles -->
        <nav class="bottom-nav">
            <div class="bottom-nav-items">
                <a href="patient_dashboard.html" class="bottom-nav-item">
                    <i class="fas fa-home"></i>
                    <span>Inicio</span>
                </a>
                <a href="medications.html" class="bottom-nav-item active">
                    <i class="fas fa-pills"></i>
                    <span>Medicamentos</span>
                </a>
                <a href="appointments.html" class="bottom-nav-item">
                    <i class="fas fa-calendar-check"></i>
                    <span>Citas</span>
                </a>
                <a href="symptom_history.html" class="bottom-nav-item">
                    <i class="fas fa-heart-pulse"></i>
                    <span>Síntomas</span>
                </a>
                <a href="more.html" class="bottom-nav-item">
                    <i class="fas fa-ellipsis-h"></i>
                    <span>Más</span>
                </a>
            </div>
        </nav>
    </div>
    
    <!-- Modal para ver detalles de medicamento -->
    <div class="modal" id="medicationDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalMedicationName">Nombre del Medicamento</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="medicationDetails">
                    <!-- Detalles del medicamento -->
                    <div class="details-section">
                        <h3>Información General</h3>
                        <p><strong>Dosis:</strong> <span id="modalDose">400mg</span></p>
                        <p><strong>Instrucciones:</strong> <span id="modalInstructions">Tomar con alimentos</span></p>
                        <p><strong>Fecha de inicio:</strong> <span id="modalStartDate">01/06/2024</span></p>
                        <p><strong>Fecha de finalización:</strong> <span id="modalEndDate">30/06/2024</span></p>
                    </div>
                    
                    <div class="details-section">
                        <h3>Horario</h3>
                        <div class="med-schedule">
                            <div class="med-time-row">
                                <div class="med-time-indicator med-time-morning">M</div>
                                <span>8:00 AM</span>
                            </div>
                            <div class="med-time-row">
                                <div class="med-time-indicator med-time-evening">T</div>
                                <span>8:00 PM</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="dose-history">
                    <h3>Historial de Dosis</h3>
                    <div id="doseHistory">
                        <!-- Historial de dosis -->
                        <ul class="dose-list">
                            <li class="dose-item">
                                <div class="dose-info">
                                    <span class="med-status med-taken"></span>
                                    <span>Ibuprofeno 400mg</span>
                                </div>
                                <span class="dose-date">Hoy, 8:00 AM</span>
                            </li>
                            <li class="dose-item">
                                <div class="dose-info">
                                    <span class="med-status med-taken"></span>
                                    <span>Ibuprofeno 400mg</span>
                                </div>
                                <span class="dose-date">Ayer, 8:00 PM</span>
                            </li>
                            <li class="dose-item">
                                <div class="dose-info">
                                    <span class="med-status med-missed"></span>
                                    <span>Ibuprofeno 400mg</span>
                                </div>
                                <span class="dose-date">Ayer, 8:00 AM</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="editMedicationBtn">Editar</button>
                <button class="btn btn-warning" id="deleteMedicationBtn">Eliminar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de confirmación para eliminar -->
    <div class="modal" id="confirmDeleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirmar Eliminación</h2>
                <button class="modal-close" id="closeConfirmModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar este medicamento? Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelDeleteBtn">Cancelar</button>
                <button class="btn btn-warning" id="confirmDeleteBtn">Eliminar</button>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticación
            const currentUser = Meditrack.getCurrentUser();
            if (!currentUser || currentUser.userType !== 'patient') {
                window.location.href = 'login.html';
                return;
            }
            
            // Toggle del menú móvil
            document.querySelector('.menu-toggle').addEventListener('click', function() {
                document.querySelector('.sidebar').classList.toggle('active');
            });
            
            // Configurar botón de cerrar sesión
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                Meditrack.logout();
            });
            
            // Referencias a elementos DOM
            const medicationsList = document.getElementById('medicationsList');
            const statusFilter = document.getElementById('statusFilter');
            const medicationSearch = document.getElementById('medicationSearch');
            const searchBtn = document.getElementById('searchBtn');
            const alertMessage = document.getElementById('alertMessage');
            
            // Referencias a modales
            const medicationDetailsModal = document.getElementById('medicationDetailsModal');
            const closeModal = document.getElementById('closeModal');
            const modalMedicationName = document.getElementById('modalMedicationName');
            const medicationDetails = document.getElementById('medicationDetails');
            const doseHistory = document.getElementById('doseHistory');
            const editMedicationBtn = document.getElementById('editMedicationBtn');
            const deleteMedicationBtn = document.getElementById('deleteMedicationBtn');
            
            // Referencias al modal de confirmación
            const confirmDeleteModal = document.getElementById('confirmDeleteModal');
            const closeConfirmModal = document.getElementById('closeConfirmModal');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            
            let currentMedication = null; // Para almacenar el medicamento actualmente seleccionado
            
            // Cargar la lista de medicamentos
            loadMedications();
            
            // Eventos para filtros
            statusFilter.addEventListener('change', loadMedications);
            searchBtn.addEventListener('click', loadMedications);
            medicationSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadMedications();
                }
            });
            
            // Eventos para modales
            closeModal.addEventListener('click', function() {
                medicationDetailsModal.style.display = 'none';
            });
            
            closeConfirmModal.addEventListener('click', function() {
                confirmDeleteModal.style.display = 'none';
            });
            
            cancelDeleteBtn.addEventListener('click', function() {
                confirmDeleteModal.style.display = 'none';
            });
            
            confirmDeleteBtn.addEventListener('click', function() {
                if (currentMedication) {
                    Meditrack.medications.delete(currentMedication.id);
                    confirmDeleteModal.style.display = 'none';
                    medicationDetailsModal.style.display = 'none';
                    
                    // Mostrar mensaje de éxito
                    showAlert('Medicamento eliminado correctamente.', 'success');
                    
                    // Recargar la lista
                    loadMedications();
                }
            });
            
            editMedicationBtn.addEventListener('click', function() {
                if (currentMedication) {
                    // Implementación simplificada - en un escenario real, redirigir a una página de edición
                    // con el ID del medicamento, o abrir un formulario modal de edición
                    showAlert('La funcionalidad de edición está simulada en este prototipo.', 'warning');
                }
            });
            
            deleteMedicationBtn.addEventListener('click', function() {
                if (currentMedication) {
                    confirmDeleteModal.style.display = 'block';
                }
            });
            
            // Cerrar modales al hacer clic fuera de ellos
            window.addEventListener('click', function(e) {
                if (e.target === medicationDetailsModal) {
                    medicationDetailsModal.style.display = 'none';
                }
                if (e.target === confirmDeleteModal) {
                    confirmDeleteModal.style.display = 'none';
                }
            });
            
            // Función para cargar medicamentos
            function loadMedications() {
                const status = statusFilter.value;
                const searchTerm = medicationSearch.value.toLowerCase();
                
                // Obtener todos los medicamentos
                let medications = Meditrack.medications.getAll();
                
                // Filtrar por estado si es necesario
                if (status === 'active') {
                    medications = medications.filter(med => med.active);
                } else if (status === 'completed') {
                    medications = medications.filter(med => !med.active);
                }
                
                // Filtrar por término de búsqueda si es necesario
                if (searchTerm) {
                    medications = medications.filter(med => 
                        med.name.toLowerCase().includes(searchTerm) ||
                        med.form.toLowerCase().includes(searchTerm)
                    );
                }
                
                // Mostrar resultados
                if (medications.length > 0) {
                    medicationsList.innerHTML = '';
                    
                    medications.forEach(med => {
                        const card = createMedicationCard(med);
                        medicationsList.appendChild(card);
                    });
                } else {
                    medicationsList.innerHTML = `
                        <div class="empty-state">
                            <div class="feature-icon-container feature-icon-med">
                                <i class="fas fa-prescription-bottle-medical"></i>
                            </div>
                            <p>No se encontraron medicamentos.</p>
                            <a href="add_medication.html" class="btn btn-primary mt-2">Añadir Medicamento</a>
                        </div>
                    `;
                }
            }
            
            // Función para crear una tarjeta de medicamento
            function createMedicationCard(medication) {
                const card = document.createElement('div');
                card.className = 'medication-card';
                
                // Determinar estado del medicamento
                let statusClass = 'status-active';
                let statusText = 'Activo';
                
                if (!medication.active) {
                    statusClass = 'status-completed';
                    statusText = 'Completado';
                }
                
                // Determinar próxima dosis
                let nextDoseText = 'No programado';
                if (medication.schedule) {
                    if (medication.schedule.frequency === 'daily') {
                        nextDoseText = 'Diariamente';
                        if (medication.schedule.times && medication.schedule.times.length > 0) {
                            nextDoseText = `Hoy a las ${medication.schedule.times[0]}`;
                        }
                    } else if (medication.schedule.frequency === 'specific-days') {
                        // Mapear números de día a nombres cortos
                        const dayNames = ['D', 'L', 'M', 'X', 'J', 'V', 'S'];
                        const daysList = medication.schedule.specificDays.map(day => dayNames[day]).join(', ');
                        nextDoseText = `${daysList}`;
                    }
                }
                
                card.innerHTML = `
                    <div class="medication-card-header">
                        <h3>${medication.name}</h3>
                        <span class="medication-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="medication-card-body">
                        <div class="med-info-row">
                            <div class="med-time-row">
                                <div class="med-time-indicator med-time-morning">M</div>
                                <span>${medication.schedule && medication.schedule.times && medication.schedule.times.length > 0 ? medication.schedule.times[0] : 'No programado'}</span>
                            </div>
                            <div class="med-time-row">
                                <div class="med-time-indicator med-time-evening">T</div>
                                <span>${medication.schedule && medication.schedule.times && medication.schedule.times.length > 1 ? medication.schedule.times[1] : 'No programado'}</span>
                            </div>
                        </div>
                        <p><strong>Dosis:</strong> ${medication.dose}</p>
                        <p><strong>Forma:</strong> ${medication.form}</p>
                        <p><strong>Próxima toma:</strong> <span class="highlight-text">${nextDoseText}</span></p>
                    </div>
                    <div class="medication-card-footer">
                        <button class="btn btn-outline btn-sm view-details-btn" data-id="${medication.id}">
                            Ver Detalles
                        </button>
                        <button class="btn btn-primary btn-sm take-dose-btn" data-id="${medication.id}">
                            Tomar Dosis
                        </button>
                    </div>
                `;
                
                // Evento para ver detalles
                card.querySelector('.view-details-btn').addEventListener('click', function() {
                    const medicationId = this.getAttribute('data-id');
                    showMedicationDetails(medicationId);
                });
                
                // Evento para tomar dosis
                card.querySelector('.take-dose-btn').addEventListener('click', function() {
                    const medicationId = this.getAttribute('data-id');
                    takeDose(medicationId);
                });
                
                return card;
            }
            
            // Función para mostrar detalles de un medicamento
            function showMedicationDetails(medicationId) {
                const medication = Meditrack.medications.getById(medicationId);
                
                if (medication) {
                    currentMedication = medication;
                    
                    // Actualizar título del modal
                    modalMedicationName.textContent = medication.name;
                    
                    // Preparar detalles del medicamento
                    let scheduleText = 'No programado';
                    if (medication.schedule) {
                        if (medication.schedule.frequency === 'daily') {
                            scheduleText = `Diariamente, ${medication.schedule.timesPerDay || 1} veces al día`;
                        } else if (medication.schedule.frequency === 'specific-days') {
                            // Mapear números de día a nombres
                            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                            const daysList = medication.schedule.specificDays.map(day => dayNames[day]).join(', ');
                            scheduleText = `Días específicos (${daysList}), ${medication.schedule.timesPerDay || 1} veces por día`;
                        }
                    }
                    
                    // Mostrar horarios específicos si están disponibles
                    let timesText = '';
                    if (medication.schedule && medication.schedule.times && medication.schedule.times.length > 0) {
                        timesText = `<p><strong>Horarios:</strong> ${medication.schedule.times.join(', ')}</p>`;
                    }
                    
                    medicationDetails.innerHTML = `
                        <div class="details-section">
                            <h3>Información General</h3>
                            <p><strong>Dosis:</strong> ${medication.dose}</p>
                            <p><strong>Forma:</strong> ${medication.form}</p>
                            <p><strong>Instrucciones:</strong> ${medication.instructions || 'No especificadas'}</p>
                            <p><strong>Frecuencia:</strong> ${scheduleText}</p>
                            ${timesText}
                            <p><strong>Fecha de inicio:</strong> ${Meditrack.utils.formatDate(medication.startDate)}</p>
                            <p><strong>Fecha de fin:</strong> ${medication.endDate ? Meditrack.utils.formatDate(medication.endDate) : 'No especificada'}</p>
                        </div>
                    `;
                    
                    // Mostrar historial de dosis
                    if (medication.doses && medication.doses.length > 0) {
                        let doseHistoryHtml = '<ul class="dose-list">';
                        
                        medication.doses.sort((a, b) => b.timestamp - a.timestamp).forEach(dose => {
                            const doseDate = new Date(dose.timestamp);
                            doseHistoryHtml += `
                                <li class="dose-item">
                                    <div class="dose-info">
                                        <span class="med-status ${dose.taken ? 'med-taken' : 'med-missed'}"></span>
                                        <span>${medication.name} ${medication.dose}mg</span>
                                    </div>
                                    <span class="dose-date">${doseDate.toLocaleString()}</span>
                                </li>
                            `;
                        });
                        
                        doseHistoryHtml += '</ul>';
                        doseHistory.innerHTML = doseHistoryHtml;
                    } else {
                        doseHistory.innerHTML = '<p class="no-data">No hay registros de dosis tomadas.</p>';
                    }
                    
                    // Mostrar modal
                    medicationDetailsModal.style.display = 'block';
                }
            }
            
            // Función para tomar una dosis
            function takeDose(medicationId) {
                if (Meditrack.medications.takeDose(medicationId)) {
                    // Mostrar mensaje de éxito
                    showAlert('Dosis registrada correctamente.', 'success');
                    
                    // Mostrar notificación solo si el permiso ya ha sido otorgado
                    const notificationState = Meditrack.getNotificationPermissionState();
                    if (notificationState === 'granted') {
                        Meditrack.showNotification('Dosis registrada', {
                            body: '¡Bien hecho! Has registrado correctamente tu medicación.',
                            icon: 'images/med-icon.png'
                        });
                    }
                    
                    // Recargar la lista
                    loadMedications();
                }
            }
            
            // Función para mostrar alertas
            function showAlert(message, type = 'info') {
                alertMessage.textContent = message;
                alertMessage.className = `alert alert-${type}`;
                alertMessage.style.display = 'block';
                
                // Ocultar después de 5 segundos
                setTimeout(() => {
                    alertMessage.style.display = 'none';
                }, 5000);
            }
        });
    </script>
</body>
</html> 