<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard del Paciente - Meditrack</title>
    <link rel="stylesheet" href="../../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="../../images/app-icon.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Verificar si estamos ejecutando desde sistema de archivos o servidor
        const isLocalFile = window.location.protocol === 'file:';

        // Función para corregir rutas de archivos cuando se ejecuta localmente
        function getCorrectPath(path) {
            return path;
        }
        
        // Función para cargar un script dinámicamente con manejo de errores
        function loadScript(src, callback) {
            var script = document.createElement('script');
            script.src = src;
            script.onload = function() { callback(true); };
            script.onerror = function() { 
                console.error('Error al cargar script:', src);
                // Intentar con ruta alternativa
                if (src === 'js/app.js') {
                    var script2 = document.createElement('script');
                    script2.src = './js/app.js'; // Intentar con ruta relativa alternativa
                    script2.onload = function() { callback(true); };
                    script2.onerror = function() { callback(false); };
                    document.head.appendChild(script2);
                } else {
                    callback(false);
                }
            };
            document.head.appendChild(script);
        }
        
        // Cargar app.js
        window.appLoaded = false;
        loadScript('js/app.js', function(success) {
            window.appLoaded = success;
            console.log('App.js cargado:', success);
            if (!success) {
                console.warn('No se pudo cargar app.js, la aplicación puede no funcionar correctamente');
            }
        });
    </script>
</head>
<body>
    <div class="app-container">
        <!-- Barra lateral -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="images/app-icon.png" alt="MediTrack" width="30" height="30">
                    MediTrack
                </div>
            </div>
            <nav class="sidebar-nav">
                <a href="patient_dashboard.html" class="sidebar-nav-item active">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="medications.html" class="sidebar-nav-item">
                    <i class="fas fa-pills"></i> Medicamentos
                </a>
                <a href="appointments.html" class="sidebar-nav-item">
                    <i class="fas fa-calendar-check"></i> Citas
                </a>
                <a href="symptom_history.html" class="sidebar-nav-item">
                    <i class="fas fa-heart-pulse"></i> Síntomas
                </a>
                <a href="rewards.html" class="sidebar-nav-item">
                    <i class="fas fa-trophy"></i> Recompensas
                </a>
                <a href="patient_profile.html" class="sidebar-nav-item">
                    <i class="fas fa-user"></i> Perfil
                </a>
                <a href="#" id="logoutBtn" class="sidebar-nav-item">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </a>
            </nav>
        </aside>

        <!-- Contenido principal -->
        <main class="main-content">
            <!-- Encabezado -->
            <header class="header">
                <div class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </div>
                <div class="header-title">Dashboard</div>
                <div class="header-actions">
                    <div class="notification-bell">
                        <i class="fas fa-bell"></i>
                        <span id="notificationCount" class="notification-badge">0</span>
                    </div>
                    <span id="patientName">Paciente</span>
                </div>
            </header>

            <!-- Área de contenido -->
            <div class="content-area">
                <div class="dashboard-header">
                    <h1>Bienvenido, <span id="patientNameHeader">Paciente</span></h1>
                    <p>Aquí puedes gestionar todos los aspectos de tu salud.</p>
                </div>
                
                <!-- Resumen de estado de salud -->
                <div class="health-status-summary">
                    <div class="health-status-item">
                        <div class="status-icon">
                            <i class="fas fa-heartbeat"></i>
                        </div>
                        <div class="status-info">
                            <h3>Adherencia</h3>
                            <div class="status-value" id="adherenceSummary">0%</div>
                        </div>
                    </div>
                    <div class="health-status-item">
                        <div class="status-icon">
                            <i class="fas fa-prescription-bottle-medical"></i>
                        </div>
                        <div class="status-info">
                            <h3>Medicamentos</h3>
                            <div class="status-value" id="medicationCount">0</div>
                        </div>
                    </div>
                    <div class="health-status-item">
                        <div class="status-icon">
                            <i class="fas fa-stethoscope"></i>
                        </div>
                        <div class="status-info">
                            <h3>Próxima Cita</h3>
                            <div class="status-value" id="nextAppointment">No hay citas</div>
                        </div>
                    </div>
                    <div class="health-status-item">
                        <div class="status-icon feature-icon-profile">
                            <i class="fas fa-award"></i>
                        </div>
                        <div class="status-info">
                            <h3>Nivel</h3>
                            <div class="status-value" id="levelSummary">Nivel 1</div>
                        </div>
                    </div>
                </div>

                <!-- Calendario semanal -->
                <div class="dashboard-card">
                    <div class="dashboard-card-title">
                        <i class="fas fa-calendar-days"></i> Tu Semana
                    </div>
                    <div class="dashboard-card-content">
                        <div class="week-days" id="weekDays">
                            <!-- Se generará dinámicamente -->
                        </div>
                        <div class="health-tip mt-3">
                            <p><i class="fas fa-lightbulb"></i> <span id="healthTip">Mantener una buena hidratación es fundamental para facilitar la absorción de medicamentos.</span></p>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-cards">
                    <!-- Tarjeta de Medicamentos -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">
                            <i class="fas fa-pills"></i> Mis Medicamentos
                        </div>
                        <div id="medicationsReminders" class="dashboard-card-content">
                            <div class="empty-state">
                                <div class="feature-icon-container feature-icon-med">
                                    <i class="fas fa-prescription-bottle-medical"></i>
                                </div>
                                <p>No tienes medicamentos registrados.</p>
                                <a href="add_medication.html" class="btn btn-primary mt-2">Añadir Medicamento</a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tarjeta de Citas -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">
                            <i class="fas fa-calendar-check"></i> Próximas Citas
                        </div>
                        <div id="appointmentsReminders" class="dashboard-card-content">
                            <div class="empty-state">
                                <div class="feature-icon-container feature-icon-appointment">
                                    <i class="fas fa-stethoscope"></i>
                                </div>
                                <p>No tienes citas programadas.</p>
                                <a href="add_appointment.html" class="btn btn-primary mt-2">Añadir Cita</a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tarjeta de Síntomas -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">
                            <i class="fas fa-heart-pulse"></i> Últimos Síntomas
                        </div>
                        <div id="recentSymptoms" class="dashboard-card-content">
                            <div class="empty-state">
                                <div class="feature-icon-container feature-icon-symptom">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                                <p>No has registrado ningún síntoma recientemente.</p>
                                <a href="log_symptom.html" class="btn btn-primary mt-2">Registrar Síntoma</a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tarjeta de Adherencia con gráfico -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">
                            <i class="fas fa-chart-line"></i> Mi Adherencia
                        </div>
                        <div class="dashboard-card-content">
                            <div class="adherence-chart">
                                <div class="adherence-percentage" id="adherencePercentage">0%</div>
                                <p>Adherencia a la medicación en los últimos 7 días</p>
                            </div>
                            <div class="canvas-container">
                                <canvas id="adherenceChart"></canvas>
                            </div>
                            <a href="report.html" class="btn btn-outline mt-2">Ver Informe Completo</a>
                        </div>
                    </div>
                    
                    <!-- Tarjeta de Recompensas -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">
                            <i class="fas fa-trophy"></i> Mis Recompensas
                        </div>
                        <div id="rewardsPreview" class="dashboard-card-content">
                            <div class="rewards-progress">
                                <div class="rewards-level">
                                    <span class="level-icon">1</span>
                                    <span class="level-name">Principiante en Salud</span>
                                </div>
                                <p>Puntos: <span id="userPoints">0</span></p>
                                <div class="progress-bar">
                                    <div class="progress" id="levelProgress" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div id="badgesPreview" class="badges-preview">
                                <!-- Las insignias se cargarán dinámicamente aquí -->
                            </div>
                            <a href="rewards.html" class="btn btn-outline mt-2">Ver Todas mis Recompensas</a>
                        </div>
                    </div>
                    
                    <!-- Tarjeta de Acciones Rápidas -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">
                            <i class="fas fa-bolt"></i> Acciones Rápidas
                        </div>
                        <div class="dashboard-card-content">
                            <div class="quick-actions">
                                <a href="add_medication.html" class="quick-action">
                                    <i class="fas fa-prescription-bottle-medical"></i>
                                    <span>Añadir Medicamento</span>
                                </a>
                                <a href="add_appointment.html" class="quick-action">
                                    <i class="fas fa-calendar-plus"></i>
                                    <span>Añadir Cita</span>
                                </a>
                                <a href="log_symptom.html" class="quick-action">
                                    <i class="fas fa-clipboard-list"></i>
                                    <span>Registrar Síntoma</span>
                                </a>
                                <a href="patient_profile.html" class="quick-action">
                                    <i class="fas fa-user-gear"></i>
                                    <span>Editar Perfil</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Barra de navegación inferior para móviles -->
        <nav class="bottom-nav">
            <div class="bottom-nav-items">
                <a href="patient_dashboard.html" class="bottom-nav-item active">
                    <i class="fas fa-home"></i>
                    <span>Inicio</span>
                </a>
                <a href="medications.html" class="bottom-nav-item">
                    <i class="fas fa-pills"></i>
                    <span>Medicamentos</span>
                </a>
                <a href="appointments.html" class="bottom-nav-item">
                    <i class="fas fa-calendar-check"></i>
                    <span>Citas</span>
                </a>
                <a href="symptom_history.html" class="bottom-nav-item">
                    <i class="fas fa-heart-pulse"></i>
                    <span>Síntomas</span>
                </a>
                <a href="more.html" class="bottom-nav-item">
                    <i class="fas fa-ellipsis-h"></i>
                    <span>Más</span>
                </a>
            </div>
        </nav>
    </div>

<<<<<<< HEAD:pages/patient/patient_dashboard.html
    <script src="../../js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticación
            const currentUser = Meditrack.getCurrentUser();
            if (!currentUser || currentUser.userType !== 'patient') {
                window.location.href = '../auth/login.html';
=======
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard cargado, verificando autenticación...');
            
            // Implementación fallback si Meditrack no está disponible
            if (typeof window.Meditrack === 'undefined') {
                console.warn('Meditrack no está disponible, usando implementación fallback');
                
                window.Meditrack = {
                    getCurrentUser: function() {
                        try {
                            const userData = localStorage.getItem('currentUser');
                            return userData ? JSON.parse(userData) : null;
                        } catch (e) {
                            console.error('Error al leer el usuario:', e);
                            return null;
                        }
                    },
                    
                    logout: function() {
                        try {
                            localStorage.removeItem('currentUser');
                            window.location.href = 'index.html';
                        } catch (e) {
                            console.error('Error al cerrar sesión:', e);
                            window.location.href = 'index.html';
                        }
                    },
                    
                    medications: {
                        getAll: function() {
                            try {
                                const medsData = localStorage.getItem('medications');
                                return medsData ? JSON.parse(medsData) : [];
                            } catch (e) {
                                console.error('Error al obtener medicamentos:', e);
                                return [];
                            }
                        }
                    },
                    
                    utils: {
                        loadAdherenceChart: function(canvasId) {
                            console.log('Cargando gráfico de adherencia (fallback)...');
                            if (window.Chart && document.getElementById(canvasId)) {
                                const ctx = document.getElementById(canvasId).getContext('2d');
                                const data = [85, 80, 90, 85, 90, 75, 85];
                                
                                document.getElementById('adherenceSummary').textContent = '85%';
                                document.getElementById('adherencePercentage').textContent = '85%';
                                
                                // Datos de ejemplo
                                const chartData = {
                                    labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
                                    datasets: [{
                                        label: 'Adherencia',
                                        data: data,
                                        backgroundColor: 'rgba(58, 123, 213, 0.2)',
                                        borderColor: '#3a7bd5',
                                        borderWidth: 2,
                                        borderRadius: 5,
                                        tension: 0.3
                                    }]
                                };
                                
                                new Chart(ctx, {
                                    type: 'bar',
                                    data: chartData,
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        scales: {
                                            y: {
                                                beginAtZero: true,
                                                max: 100,
                                                ticks: {
                                                    callback: function(value) {
                                                        return value + '%';
                                                    }
                                                }
                                            }
                                        },
                                        plugins: {
                                            legend: {
                                                display: false
                                            }
                                        }
                                    }
                                });
                            }
                        }
                    }
                };
            }
            
            // Verificar que el usuario está autenticado
            const currentUser = window.Meditrack.getCurrentUser();
            console.log('Usuario actual:', currentUser);
            
            if (!currentUser) {
                console.error('Usuario no autenticado, redirigiendo a login');
                window.location.href = 'login.html';
>>>>>>> cambios-temporales:patient_dashboard.html
                return;
            }
            
            // Mostrar información del usuario
            const patientNameSpan = document.getElementById('patientName');
            const patientNameHeader = document.getElementById('patientNameHeader');
            
            if (patientNameSpan) patientNameSpan.textContent = currentUser.name || 'Usuario';
            if (patientNameHeader) patientNameHeader.textContent = currentUser.name || 'Usuario';
            
            // Configurar botón de cierre de sesión
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Cerrando sesión...');
                    window.Meditrack.logout();
                });
            }
            
            // Configurar la barra lateral en dispositivos móviles
            const menuToggle = document.querySelector('.menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            
            if (menuToggle && sidebar) {
                menuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                    document.body.classList.toggle('sidebar-open');
                });
            }
            
            // Cargar datos de medicamentos
            loadMedicationData();
            
            // Generar calendario semanal
            generateWeekCalendar();
            
            // Cargar gráfico de adherencia
            if (window.Chart && document.getElementById('adherenceChart')) {
                window.Meditrack.utils.loadAdherenceChart('adherenceChart');
            }
            
            // Mostrar tip aleatorio de salud
            showRandomHealthTip();
        });
        
        // Función para generar el calendario semanal
        function generateWeekCalendar() {
            const weekDaysContainer = document.getElementById('weekDays');
            if (!weekDaysContainer) return;
            
            const days = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
            const today = new Date();
            const currentDay = today.getDay(); // 0-6, 0 = Domingo
            
            let html = '';
            
            // Ajustar para que la semana comience el lunes
            const adjustedCurrentDay = currentDay === 0 ? 6 : currentDay - 1;
            
            for (let i = 0; i < 7; i++) {
                const isToday = i === adjustedCurrentDay;
                const dayClass = isToday ? 'day today' : 'day';
                
                html += `
                    <div class="${dayClass}">
                        <div class="day-name">${days[i]}</div>
                        <div class="day-number">${getDayNumber(i, adjustedCurrentDay)}</div>
                        <div class="day-status">${isToday ? '<i class="fas fa-circle"></i>' : ''}</div>
                    </div>
                `;
            }
            
            weekDaysContainer.innerHTML = html;
        }
        
        // Función para obtener el número de día para el calendario
        function getDayNumber(dayIndex, currentDayIndex) {
            const today = new Date();
            const diff = dayIndex - currentDayIndex;
            const day = new Date(today);
            day.setDate(today.getDate() + diff);
            return day.getDate();
        }
        
        // Cargar datos de medicamentos
        function loadMedicationData() {
            if (typeof window.Meditrack === 'undefined' || !window.Meditrack.medications) {
                console.error('API de medicamentos no disponible');
                return;
            }
            
            const medications = window.Meditrack.medications.getAll();
            const medicationsContainer = document.getElementById('medicationsReminders');
            
            if (medications.length === 0) {
                console.log('No hay medicamentos registrados');
                return;
            }
            
            // Actualizar contador de medicamentos
            const medicationCountElement = document.getElementById('medicationCount');
            if (medicationCountElement) {
                medicationCountElement.textContent = medications.length;
            }
            
            // Mostrar medicamentos activos
            let html = '';
            const activeMeds = medications.filter(med => med.active);
            
            if (activeMeds.length === 0) {
                return;
            }
            
            activeMeds.forEach(med => {
                html += `
                <div class="reminder-item">
                    <div class="reminder-icon medication-icon">
                        <i class="fas fa-pills"></i>
                    </div>
                    <div class="reminder-details">
                        <h4>${med.name}</h4>
                        <p>${med.dose || ''} - ${med.form || ''}</p>
                    </div>
                    <div class="reminder-time">
                        ${getNextDoseTime(med)}
                    </div>
                </div>
                `;
            });
            
<<<<<<< HEAD:pages/patient/patient_dashboard.html
            // Funciones para cargar datos
            function loadPendingMedications() {
                const pendingMedications = Meditrack.medications.getPendingMedications();
                const medicationsContainer = document.getElementById('medicationsReminders');
                
                if (pendingMedications.length > 0) {
                    medicationsContainer.innerHTML = '';
                    
                    pendingMedications.forEach(med => {
                        const reminderElement = document.createElement('div');
                        reminderElement.className = 'reminder';
                        
                        let nextDoseTime = 'Hoy';
                        if (med.schedule && med.schedule.times && med.schedule.times.length > 0) {
                            nextDoseTime = `Hoy a las ${med.schedule.times[0]}`;
                        }
                        
                        reminderElement.innerHTML = `
                            <div class="reminder-icon">
                                <i class="fas fa-pills"></i>
                            </div>
                            <div class="reminder-content">
                                <h4>${med.name} - ${med.dose} ${med.form}</h4>
                                <p>Próxima dosis: ${nextDoseTime}</p>
                            </div>
                            <button class="btn btn-primary take-dose-btn" data-id="${med.id}">
                                Tomar
                            </button>
                        `;
                        
                        medicationsContainer.appendChild(reminderElement);
                    });
                    
                    // Agregar eventos a los botones de tomar dosis
                    document.querySelectorAll('.take-dose-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const medicationId = this.getAttribute('data-id');
                            Meditrack.medications.takeDose(medicationId);
                            loadPendingMedications(); // Recargar lista
                            
                            // Recalcular y mostrar adherencia
                            const adherencePercentage = Meditrack.utils.calculateAdherence(7);
                            document.getElementById('adherencePercentage').textContent = `${adherencePercentage}%`;
                            document.getElementById('adherenceSummary').textContent = `${adherencePercentage}%`;
                            
                            // Actualizar puntos del usuario
                            const currentUser = Meditrack.getCurrentUser();
                            document.getElementById('userPoints').textContent = currentUser.points || 0;
                            
                            // Actualizar gráfico de adherencia
                            updateAdherenceChart();
                            
                            // Mostrar notificación
                            Meditrack.showNotification('Dosis registrada', {
                                body: '¡Bien hecho! Has registrado correctamente tu medicación.',
                                icon: '../../images/med-icon.png'
                            });
                        });
                    });
                    
                } else {
                    medicationsContainer.innerHTML = `
                        <div class="empty-state">
                            <p>No tienes medicamentos pendientes para hoy.</p>
                            <a href="add_medication.html" class="btn btn-primary mt-2">Añadir Medicamento</a>
                        </div>
                    `;
                }
            }
=======
            medicationsContainer.innerHTML = html;
        }
        
        // Obtener el tiempo para la próxima dosis
        function getNextDoseTime(medication) {
            if (!medication.schedule) return 'Sin horario';
>>>>>>> cambios-temporales:patient_dashboard.html
            
            if (medication.schedule.frequency === 'daily') {
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinutes = now.getMinutes();
                const currentTime = currentHour * 60 + currentMinutes;
                
                // Buscar la próxima hora de toma
                if (medication.schedule.times && medication.schedule.times.length > 0) {
                    let nextDoseTime = null;
                    let minTimeDiff = Infinity;
                    
                    for (const time of medication.schedule.times) {
                        const [hours, minutes] = time.split(':').map(Number);
                        const doseTime = hours * 60 + minutes;
                        
                        // Calcular diferencia de tiempo
                        let timeDiff = doseTime - currentTime;
                        if (timeDiff < 0) timeDiff += 24 * 60; // Si ya pasó, sumar un día completo
                        
                        if (timeDiff < minTimeDiff) {
                            minTimeDiff = timeDiff;
                            nextDoseTime = time;
                        }
                    }
                    
                    if (nextDoseTime) {
                        return nextDoseTime;
                    }
                }
                
                return 'Hoy';
            } else if (medication.schedule.frequency === 'as-needed') {
                return 'Según necesidad';
            }
            
            return 'Sin horario';
        }
        
        // Mostrar un tip de salud aleatorio
        function showRandomHealthTip() {
            const tips = [
                'Mantener una buena hidratación es fundamental para facilitar la absorción de medicamentos.',
                'Establecer rutinas diarias te ayudará a recordar tomar tus medicamentos a tiempo.',
                'Asegúrate de leer las instrucciones de almacenamiento de tus medicamentos.',
                'Infórmale a tu médico sobre todos los medicamentos que estás tomando, incluidos suplementos.',
                'Descansar adecuadamente es tan importante como tomar tus medicamentos correctamente.',
                'La actividad física regular puede mejorar la efectividad de muchos tratamientos médicos.'
            ];
            
            const tipElement = document.getElementById('healthTip');
            if (tipElement) {
                const randomIndex = Math.floor(Math.random() * tips.length);
                tipElement.textContent = tips[randomIndex];
            }
        }
    </script>
</body>
</html> 